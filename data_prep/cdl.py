import os
import numpy as np
from webdataset import dataset as wds


def cdl_crops():
    return {1: 'Corn',
            2: 'Cotton',
            3: 'Rice',
            4: 'Sorghum',
            5: 'Soybeans',
            6: 'Sunflower',
            10: 'Peanuts',
            11: 'Tobacco',
            12: 'Sweet Corn',
            13: 'Pop or Orn Corn',
            14: 'Mint',
            21: 'Barley',
            22: 'Durum Wheat',
            23: 'Spring Wheat',
            24: 'Winter Wheat',
            25: 'Other Small Grains',
            26: 'Dbl Crop WinWht / Soybeans',
            27: 'Rye',
            28: 'Oats',
            29: 'Millet',
            30: 'Speltz',
            31: 'Canola',
            32: 'Flaxseed',
            33: 'Safflower',
            34: 'Rape Seed',
            35: 'Mustard',
            36: 'Alfalfa',
            37: 'Other Hay / NonAlfalfa',
            38: 'Camelina',
            39: 'Buckwheat',
            41: 'Sugarbeets',
            42: 'Dry Beans',
            43: 'Potatoes',
            44: 'Other Crops',
            45: 'Sugarcane',
            46: 'Sweet Potatoes',
            47: 'Misc Vegs & Fruits',
            48: 'Watermelons',
            49: 'Onions',
            50: 'Cucumbers',
            51: 'Chick Peas',
            52: 'Lentils',
            53: 'Peas',
            54: 'Tomatoes',
            55: 'Caneberries',
            56: 'Hops',
            57: 'Herbs',
            58: 'Clover/Wildflowers',
            59: 'Sod/Grass Seed',
            61: 'Fallow/Idle Cropland',
            66: 'Cherries',
            67: 'Peaches',
            68: 'Apples',
            69: 'Grapes',
            70: 'Christmas Trees',
            71: 'Other Tree Crops',
            72: 'Citrus',
            74: 'Pecans',
            75: 'Almonds',
            76: 'Walnuts',
            77: 'Pears',
            204: 'Pistachios',
            205: 'Triticale',
            206: 'Carrots',
            207: 'Asparagus',
            208: 'Garlic',
            209: 'Cantaloupes',
            210: 'Prunes',
            211: 'Olives',
            212: 'Oranges',
            213: 'Honeydew Melons',
            214: 'Broccoli',
            216: 'Peppers',
            217: 'Pomegranates',
            218: 'Nectarines',
            219: 'Greens',
            220: 'Plums',
            221: 'Strawberries',
            222: 'Squash',
            223: 'Apricots',
            224: 'Vetch',
            225: 'Dbl Crop WinWht/Corn',
            226: 'Dbl Crop Oats/Corn',
            227: 'Lettuce',
            229: 'Pumpkins',
            230: 'Dbl Crop Lettuce/Durum Wht',
            231: 'Dbl Crop Lettuce/Cantaloupe',
            232: 'Dbl Crop Lettuce/Cotton',
            233: 'Dbl Crop Lettuce/Barley',
            234: 'Dbl Crop Durum Wht/Sorghum',
            235: 'Dbl Crop Barley/Sorghum',
            236: 'Dbl Crop WinWht/Sorghum',
            237: 'Dbl Crop Barley/Corn',
            238: 'Dbl Crop WinWht/Cotton',
            239: 'Dbl Crop Soybeans/Cotton',
            240: 'Dbl Crop Soybeans/Oats',
            241: 'Dbl Crop Corn/Soybeans',
            242: 'Blueberries',
            243: 'Cabbage',
            244: 'Cauliflower',
            245: 'Celery',
            246: 'Radishes',
            247: 'Turnips',
            248: 'Eggplants',
            249: 'Gourds',
            250: 'Cranberries',
            254: 'Dbl Crop Barley/Soybeans'}


def cdl_key():
    return {1: 'Corn',
            2: 'Cotton',
            3: 'Rice',
            4: 'Sorghum',
            5: 'Soybeans',
            6: 'Sunflower',
            7: '',
            8: '',
            9: '',
            10: 'Peanuts',
            11: 'Tobacco',
            12: 'Sweet Corn',
            13: 'Pop or Orn Corn',
            14: 'Mint',
            15: '',
            16: '',
            17: '',
            18: '',
            19: '',
            20: '',
            21: 'Barley',
            22: 'Durum Wheat',
            23: 'Spring Wheat',
            24: 'Winter Wheat',
            25: 'Other Small Grains',
            26: 'Dbl Crop WinWht/Soybeans',
            27: 'Rye',
            28: 'Oats',
            29: 'Millet',
            30: 'Speltz',
            31: 'Canola',
            32: 'Flaxseed',
            33: 'Safflower',
            34: 'Rape Seed',
            35: 'Mustard',
            36: 'Alfalfa',
            37: 'Other Hay/Non Alfalfa',
            38: 'Camelina',
            39: 'Buckwheat',
            40: '',
            41: 'Sugarbeets',
            42: 'Dry Beans',
            43: 'Potatoes',
            44: 'Other Crops',
            45: 'Sugarcane',
            46: 'Sweet Potatoes',
            47: 'Misc Vegs & Fruits',
            48: 'Watermelons',
            49: 'Onions',
            50: 'Cucumbers',
            51: 'Chick Peas',
            52: 'Lentils',
            53: 'Peas',
            54: 'Tomatoes',
            55: 'Caneberries',
            56: 'Hops',
            57: 'Herbs',
            58: 'Clover/Wildflowers',
            59: 'Sod/Grass Seed',
            60: 'Switchgrass',
            61: 'Fallow/Idle Cropland',
            62: 'Pasture/Grass',
            63: 'Forest',
            64: 'Shrubland',
            65: 'Barren',
            66: 'Cherries',
            67: 'Peaches',
            68: 'Apples',
            69: 'Grapes',
            70: 'Christmas Trees',
            71: 'Other Tree Crops',
            72: 'Citrus',
            73: '',
            74: 'Pecans',
            75: 'Almonds',
            76: 'Walnuts',
            77: 'Pears',
            78: '',
            79: '',
            80: '',
            81: 'Clouds/No Data',
            82: 'Developed',
            83: 'Water',
            84: '',
            85: '',
            86: '',
            87: 'Wetlands',
            88: 'Nonag/Undefined',
            89: '',
            90: '',
            91: '',
            92: 'Aquaculture',
            93: '',
            94: '',
            95: '',
            96: '',
            97: '',
            98: '',
            99: '',
            100: '',
            101: '',
            102: '',
            103: '',
            104: '',
            105: '',
            106: '',
            107: '',
            108: '',
            109: '',
            110: '',
            111: 'Open Water',
            112: 'Perennial Ice/Snow',
            113: '',
            114: '',
            115: '',
            116: '',
            117: '',
            118: '',
            119: '',
            120: '',
            121: 'Developed/Open Space',
            122: 'Developed/Low Intensity',
            123: 'Developed/Med Intensity',
            124: 'Developed/High Intensity',
            125: '',
            126: '',
            127: '',
            128: '',
            129: '',
            130: '',
            131: 'Barren',
            132: '',
            133: '',
            134: '',
            135: '',
            136: '',
            137: '',
            138: '',
            139: '',
            140: '',
            141: 'Deciduous Forest',
            142: 'Evergreen Forest',
            143: 'Mixed Forest',
            144: '',
            145: '',
            146: '',
            147: '',
            148: '',
            149: '',
            150: '',
            151: '',
            152: 'Shrubland',
            153: '',
            154: '',
            155: '',
            156: '',
            157: '',
            158: '',
            159: '',
            160: '',
            161: '',
            162: '',
            163: '',
            164: '',
            165: '',
            166: '',
            167: '',
            168: '',
            169: '',
            170: '',
            171: '',
            172: '',
            173: '',
            174: '',
            175: '',
            176: 'Grassland/Pasture',
            177: '',
            178: '',
            179: '',
            180: '',
            181: '',
            182: '',
            183: '',
            184: '',
            185: '',
            186: '',
            187: '',
            188: '',
            189: '',
            190: 'Woody Wetlands',
            191: '',
            192: '',
            193: '',
            194: '',
            195: 'Herbaceous Wetlands',
            196: '',
            197: '',
            198: '',
            199: '',
            200: '',
            201: '',
            202: '',
            203: '',
            204: 'Pistachios',
            205: 'Triticale',
            206: 'Carrots',
            207: 'Asparagus',
            208: 'Garlic',
            209: 'Cantaloupes',
            210: 'Prunes',
            211: 'Olives',
            212: 'Oranges',
            213: 'Honeydew Melons',
            214: 'Broccoli',
            215: 'Avocados',
            216: 'Peppers',
            217: 'Pomegranates',
            218: 'Nectarines',
            219: 'Greens',
            220: 'Plums',
            221: 'Strawberries',
            222: 'Squash',
            223: 'Apricots',
            224: 'Vetch',
            225: 'Dbl Crop WinWht/Corn',
            226: 'Dbl Crop Oats/Corn',
            227: 'Lettuce',
            228: '',
            229: 'Pumpkins',
            230: 'Dbl Crop Lettuce/Durum Wht',
            231: 'Dbl Crop Lettuce/Cantaloupe',
            232: 'Dbl Crop Lettuce/Cotton',
            233: 'Dbl Crop Lettuce/Barley',
            234: 'Dbl Crop Durum Wht/Sorghum',
            235: 'Dbl Crop Barley/Sorghum',
            236: 'Dbl Crop WinWht/Sorghum',
            237: 'Dbl Crop Barley/Corn',
            238: 'Dbl Crop WinWht/Cotton',
            239: 'Dbl Crop Soybeans/Cotton',
            240: 'Dbl Crop Soybeans/Oats',
            241: 'Dbl Crop Corn/Soybeans',
            242: 'Blueberries',
            243: 'Cabbage',
            244: 'Cauliflower',
            245: 'Celery',
            246: 'Radishes',
            247: 'Turnips',
            248: 'Eggplants',
            249: 'Gourds',
            250: 'Cranberries',
            251: '',
            252: '',
            253: '',
            254: 'Dbl Crop Barley/Soybeans',
            255: ''}


def cdl_training_data():
    _map = {'13': 14, '14': 1, '15': 2, '16': 3, '17': 4, '18': 4, '19': 3, '20': 6, '21': 4, '22': 13, '23': 20,
            '24': 38, '25': 42, '26': 46, '27': 74, '28': 87, '29': 84, '30': 96, '31': 115, '32': 143, '33': 184,
            '34': 236, '35': 217, '36': 247, '37': 296, '38': 288, '39': 298, '40': 334, '41': 347, '42': 370,
            '43': 388, '44': 402, '45': 391, '46': 400, '47': 398, '48': 444, '49': 417, '50': 473, '51': 505,
            '52': 503, '53': 467, '54': 488, '55': 527, '56': 455, '57': 422, '58': 401, '59': 390, '60': 376,
            '61': 410, '62': 386, '63': 354, '64': 387, '65': 348, '66': 325, '67': 310, '68': 289, '69': 278,
            '70': 296, '71': 313, '72': 362, '73': 310, '74': 285, '75': 263, '76': 246, '77': 231, '78': 186,
            '79': 197, '80': 236, '81': 353, '82': 355, '83': 324, '84': 369, '85': 312, '86': 217, '87': 144,
            '88': 168, '89': 223, '90': 608, '91': 2173, '92': 1131, '93': 1909, '94': 1348, '95': 193, '96': 207,
            '97': 16, '100': 38029, '98': 3, '12': 6, '0': 384, '11': 1, '-1': 65536}
    return _map


def cdl_remap():
    return None


def cdl_training_data_strings():
    _map = [('Pop or Orn Corn', 14),
            ('Mint', 1),
            ('', 2),
            ('', 3),
            ('', 4),
            ('', 4),
            ('', 3),
            ('', 6),
            ('Barley', 4),
            ('Durum Wheat', 13),
            ('Spring Wheat', 20),
            ('Winter Wheat', 38),
            ('Other Small Grains', 42),
            ('Dbl Crop WinWht/Soybeans', 46),
            ('Rye', 74),
            ('Oats', 87),
            ('Millet', 84),
            ('Speltz', 96),
            ('Canola', 115),
            ('Flaxseed', 143),
            ('Safflower', 184),
            ('Rape Seed', 236),
            ('Mustard', 217),
            ('Alfalfa', 247),
            ('Other Hay/Non Alfalfa', 296),
            ('Camelina', 288),
            ('Buckwheat', 298),
            ('', 334),
            ('Sugarbeets', 347),
            ('Dry Beans', 370),
            ('Potatoes', 388),
            ('Other Crops', 402),
            ('Sugarcane', 391),
            ('Sweet Potatoes', 400),
            ('Misc Vegs & Fruits', 398),
            ('Watermelons', 444),
            ('Onions', 417),
            ('Cucumbers', 473),
            ('Chick Peas', 505),
            ('Lentils', 503),
            ('Peas', 467),
            ('Tomatoes', 488),
            ('Caneberries', 527),
            ('Hops', 455),
            ('Herbs', 422),
            ('Clover/Wildflowers', 401),
            ('Sod/Grass Seed', 390),
            ('Switchgrass', 376),
            ('Fallow/Idle Cropland', 410),
            ('Pasture/Grass', 386),
            ('Forest', 354),
            ('Shrubland', 387),
            ('Barren', 348),
            ('Cherries', 325),
            ('Peaches', 310),
            ('Apples', 289),
            ('Grapes', 278),
            ('Christmas Trees', 296),
            ('Other Tree Crops', 313),
            ('Citrus', 362),
            ('', 310),
            ('Pecans', 285),
            ('Almonds', 263),
            ('Walnuts', 246),
            ('Pears', 231),
            ('', 186),
            ('', 197),
            ('', 236),
            ('Clouds/No Data', 353),
            ('Developed', 355),
            ('Water', 324),
            ('', 369),
            ('', 312),
            ('', 217),
            ('Wetlands', 144),
            ('Nonag/Undefined', 168),
            ('', 223),
            ('', 608),
            ('', 2173),
            ('Aquaculture', 1131),
            ('', 1909),
            ('', 1348),
            ('', 193),
            ('', 207),
            ('', 16),
            ('', 38029),
            ('', 3),
            ('Sweet Corn', 6),
            ('Tobacco', 1)]


def map_cdl(root):
    counts = {}
    loc = os.path.join(root)
    urls = [os.path.join(loc, x) for x in os.listdir(loc) if x.endswith('.tar')]
    dataset = wds.Dataset(urls).decode('torchl')
    for j, f in enumerate(dataset):
        a = f['pth'].numpy()
        features = a[:, :, 97].astype(int)
        print(np.count_nonzero(features == -1), features.size)
        ct = np.unique(features, return_counts=True)
        for (crop, num) in zip(list(ct[0]), list(ct[1])):
            if crop == -1:
                print(crop, num)
            if crop not in counts.keys():
                counts[str(crop)] = num
            else:
                counts[str(crop)] += num


if __name__ == '__main__':
    data = '/home/dgketchum/IrrigationGIS/tfrecords/tarchives'

    if not os.path.isdir(data):
        data = '/mnt/beegfs/dk128872/ts_data/cmask/tar'

    images = os.path.join(data, 'images')

    for split in ['train', 'test', 'valid']:
        np_images = os.path.join(images, split)
        map_cdl(np_images)
# ========================= EOF ====================================================================
